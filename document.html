<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A comprehensive analysis of weekly box-office data using time series forecasting techniques.">

<title>Weekly Box-Office Time Series Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="document_files/libs/clipboard/clipboard.min.js"></script>
<script src="document_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="document_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="document_files/libs/quarto-html/popper.min.js"></script>
<script src="document_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="document_files/libs/quarto-html/anchor.min.js"></script>
<link href="document_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="document_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="document_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="document_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="document_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Weekly Box-Office Time Series Analysis</h1>
</div>

<div>
  <div class="description">
    A comprehensive analysis of weekly box-office data using time series forecasting techniques.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><img src="box_office.jpg" align="center" alt="Box Office Image"></p>
<section id="table-of-contents" class="level1">
<h1>Table of Contents</h1>
<ul>
<li><a href="#table-of-contents">Table of Contents</a>
<ul>
<li><a href="#**1-introduction**"><strong>1. Introduction</strong></a></li>
<li><a href="#**2-data-visualisation**"><strong>2. Data Visualisation</strong></a></li>
<li><a href="#**3-time-series-modelling**"><strong>3. Time Series Modelling</strong></a>
<ul>
<li><a href="#**31-simple-exponential-smoothing**">3.1. Simple Exponential smoothing</a></li>
<li><a href="#32-**holt-winter-multiplicative-trend**">3.2. Holt-Winter Multiplicative trend</a></li>
<li><a href="#**33-prophet-model-(meta)**">3.3. Prophet model (Meta)</a></li>
<li><a href="#**34-auto-regressive-integrated-moving-average**">3.4. Auto Regressive Integrated Moving Average</a></li>
</ul></li>
<li><a href="#**4-a-weighted-average-combination-of-all-forecast**"><strong>4. A Weighted-Average Combination of all forecast</strong></a></li>
<li><a href="#**5-implementation-of-the-averaging-model**"><strong>5. Implementation of the Averaging Model</strong></a></li>
<li><a href="#**6-another-machine-learning-approach-to-sale-forecasting**"><strong>6. Another machine learning approach to sale forecasting</strong></a>
<ul>
<li><a href="#**61-feature-engineering**">6.1 Feature Engineering</a>
<ul>
<li><a href="#**skewness-and-normalizing-variable**">Skewness and Normalizing Variable</a></li>
<li><a href="#**train-test-split**">Train-Test Split</a></li>
</ul></li>
<li><a href="#**62-modelling**">6.2 Modelling</a>
<ul>
<li><a href="#**cross-validation**">Cross Validation</a></li>
<li><a href="#**621-linear-regression**">6.2.1 Linear Regression</a></li>
<li><a href="#**622-xgboost**">6.2.2 XGBoost</a></li>
<li><a href="#**623-lightgbm**">6.2.3 LightGBM</a></li>
</ul></li>
<li><a href="#**63-averaging-model**">6.3 Averaging Model</a></li>
<li><a href="#**64-making-prediction**">6.4 Making Prediction</a></li>
</ul></li>
</ul></li>
<li><a href="#**conclusion**"><strong>Conclusion</strong></a></li>
</ul>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction"><strong>1. Introduction</strong></h2>
<p>The dataset was originally a JSON file, retrieved from private repository. I began by flattening and normalizing the JSON box-office data into a clean Pandas DataFrame, then reshaped it into a proper time-series format indexed by week. From there, I trained and evaluated several established forecasting models—such as Holt_winter, SARIMAX, and Prophet—on the “Red Shoes” dataset. To further improve accuracy, I engineered a custom ensemble averaging method that reduced training MAPE to just 1%. This end-to-end pipeline not only demonstrates robust model comparison but also delivers a highly accurate, easily extensible framework for predicting weekly grosses.</p>
<p><strong>Import libraries</strong></p>
<div id="cell-6" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Time Series Dataframe</strong></p>
<div id="cell-8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="d70afbb8-3703-4237-ad47-6652d8e9af38" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Using regular expression</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(<span class="st">'red_shoes_data.xlsx'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>money_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> re.search(<span class="vs">r'boxOffice</span><span class="cf">|</span><span class="vs">release_cumulativeBoxOffice'</span>, c)]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>df[money_cols] <span class="op">=</span> df[money_cols] <span class="op">/</span> <span class="dv">100</span> <span class="co"># normalize sales because it is scaled by 100 in the original dataset</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract week number</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'week'</span>] <span class="op">=</span> df[<span class="st">'source_file'</span>].<span class="bu">str</span>.extract(<span class="vs">r'week</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get daily gross using RG</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>day_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> re.match(<span class="vs">r'boxOffice_day</span><span class="dv">\d</span><span class="op">+</span><span class="vs">_today</span><span class="dv">$</span><span class="vs">'</span>, c)]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Melt the dataset</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>df_long <span class="op">=</span> pd.melt(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span>[<span class="st">'week'</span>],</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>day_cols,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">'day_label'</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">'daily_gross'</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute day-of-week index</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'day'</span>]    <span class="op">=</span> df_long[<span class="st">'day_label'</span>].<span class="bu">str</span>.extract(<span class="vs">r'day</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">_today'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'abs_day'</span>] <span class="op">=</span> (df_long[<span class="st">'week'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">7</span> <span class="op">+</span> df_long[<span class="st">'day'</span>]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>release_date <span class="op">=</span> pd.to_datetime(<span class="st">'2020-06-26'</span>) <span class="co"># real calendar release date of Red Shoes</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'date'</span>] <span class="op">=</span> release_date <span class="op">+</span> pd.to_timedelta(df_long[<span class="st">'abs_day'</span>] <span class="op">-</span> <span class="dv">1</span>, unit<span class="op">=</span><span class="st">'d'</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across theatres for total daily gross</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>df_daily <span class="op">=</span> df_long.groupby(<span class="st">'date'</span>, as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_gross'</span>].<span class="bu">sum</span>()</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_daily)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         date  daily_gross
0  2020-06-26     27670.75
1  2020-06-27     35043.16
2  2020-06-28     40662.80
3  2020-06-29     35751.27
4  2020-06-30     52781.68
..        ...          ...
72 2020-09-06       520.49
73 2020-09-07       953.98
74 2020-09-08       223.98
75 2020-09-09        36.00
76 2020-09-10        36.00

[77 rows x 2 columns]</code></pre>
</div>
</div>
<p><strong>Longer format for deeper analysis</strong></p>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:394}}" data-outputid="fe4d6add-f93b-4d66-a561-54e7c61faade" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(<span class="st">'red_shoes_data.xlsx'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'week'</span>] <span class="op">=</span> df[<span class="st">'source_file'</span>].<span class="bu">str</span>.extract(<span class="vs">r'week</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>day_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> re.match(<span class="vs">r'boxOffice_day</span><span class="dv">\d</span><span class="op">+</span><span class="vs">_today</span><span class="dv">$</span><span class="vs">'</span>, col)]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>id_vars <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> day_cols]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Melt into long format</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>df_long <span class="op">=</span> df.melt(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span>id_vars,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>day_cols,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">'day_label'</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">'daily_gross'</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#compute absolute day index</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'day_of_week'</span>] <span class="op">=</span> df_long[<span class="st">'day_label'</span>].<span class="bu">str</span>.extract(<span class="vs">r'day</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">_today'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'abs_day'</span>]     <span class="op">=</span> (df_long[<span class="st">'week'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">7</span> <span class="op">+</span> df_long[<span class="st">'day_of_week'</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>release_date <span class="op">=</span> pd.to_datetime(<span class="st">'2020-06-26'</span>)  <span class="co"># real calendar date</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'date'</span>] <span class="op">=</span> release_date <span class="op">+</span> pd.to_timedelta(df_long[<span class="st">'abs_day'</span>] <span class="op">-</span> <span class="dv">1</span>, unit<span class="op">=</span><span class="st">'d'</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">#reorder columns so ‘date’ comes first</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'date'</span>] <span class="op">+</span> [c <span class="cf">for</span> c <span class="kw">in</span> df_long.columns <span class="cf">if</span> c <span class="op">!=</span> <span class="st">'date'</span>]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>df_long <span class="op">=</span> df_long[cols]</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_long.shape)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>df_long.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(9611, 43)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">circuitId</th>
<th data-quarto-table-cell-role="th">city</th>
<th data-quarto-table-cell-role="th">cityId</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">region</th>
<th data-quarto-table-cell-role="th">regionId</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">stateId</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">release_cumulativeDerivedAdmissions</th>
<th data-quarto-table-cell-role="th">boxOffice_day2_yesterday</th>
<th data-quarto-table-cell-role="th">boxOffice_day6_yesterday</th>
<th data-quarto-table-cell-role="th">boxOffice_day7_yesterday</th>
<th data-quarto-table-cell-role="th">source_file</th>
<th data-quarto-table-cell-role="th">week</th>
<th data-quarto-table-cell-role="th">day_label</th>
<th data-quarto-table-cell-role="th">daily_gross</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">abs_day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2020-09-06</td>
<td>Village</td>
<td>14</td>
<td>Murray and Riverina</td>
<td>139</td>
<td>1</td>
<td>NSW Regional</td>
<td>38</td>
<td>New South Wales (inc ACT)</td>
<td>2</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>redshoes_week11.json</td>
<td>11</td>
<td>boxOffice_day3_today</td>
<td>13999.0</td>
<td>3</td>
<td>73</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2020-09-06</td>
<td>Reading</td>
<td>12</td>
<td>Wide Bay</td>
<td>55</td>
<td>2</td>
<td>QLD Regional</td>
<td>39</td>
<td>Queensland</td>
<td>4</td>
<td>...</td>
<td>422.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>redshoes_week11.json</td>
<td>11</td>
<td>boxOffice_day3_today</td>
<td>3600.0</td>
<td>3</td>
<td>73</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2020-09-06</td>
<td>Reading</td>
<td>12</td>
<td>Adelaide - North</td>
<td>120</td>
<td>3</td>
<td>Adelaide</td>
<td>1</td>
<td>South Australia</td>
<td>5</td>
<td>...</td>
<td>1277.0</td>
<td>4800.0</td>
<td>2400.0</td>
<td>2400.0</td>
<td>redshoes_week11.json</td>
<td>11</td>
<td>boxOffice_day3_today</td>
<td>10800.0</td>
<td>3</td>
<td>73</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2020-09-06</td>
<td>Hoyts</td>
<td>6</td>
<td>Perth - South East</td>
<td>9</td>
<td>4</td>
<td>Perth</td>
<td>22</td>
<td>Western Australia</td>
<td>8</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>redshoes_week11.json</td>
<td>11</td>
<td>boxOffice_day3_today</td>
<td>6999.0</td>
<td>3</td>
<td>73</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2020-09-06</td>
<td>Village</td>
<td>14</td>
<td>Hobart</td>
<td>149</td>
<td>5</td>
<td>Hobart</td>
<td>14</td>
<td>Victoria (inc TAS)</td>
<td>7</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>19998.0</td>
<td>NaN</td>
<td>redshoes_week11.json</td>
<td>11</td>
<td>boxOffice_day3_today</td>
<td>NaN</td>
<td>3</td>
<td>73</td>
</tr>
</tbody>
</table>

<p>5 rows × 43 columns</p>
</div>
</div>
</div>
<p><strong>Mapping day number to actual week day</strong></p>
<div id="cell-12" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>day_name_map <span class="op">=</span> {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Friday"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Saturday"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Sunday"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Monday"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Tuesday"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Wednesday"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Thursday"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>df_long[<span class="st">'day_name'</span>] <span class="op">=</span> df_long[<span class="st">'day_of_week'</span>].<span class="bu">map</span>(day_name_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-visualisation" class="level2">
<h2 class="anchored" data-anchor-id="data-visualisation"><strong>2. Data Visualisation</strong></h2>
<div id="cell-14" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="07341892-f715-474f-a515-b800306b7607" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>df_daily, x<span class="op">=</span><span class="st">'date'</span>, y<span class="op">=</span><span class="st">'daily_gross'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Total Daily Gross Over Time'</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total Daily Gross'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Key trends:</strong></p>
<ul>
<li><p><strong>Initial Launch Surge:</strong> In the first two weeks, gross climbs sharply to peaks above $70 000 per day, reflecting strong opening and word-of-mouth momentum.</p></li>
<li><p><strong>Clear Weekly Spikes:</strong> After the initial run, you see recurring spikes roughly every seven days—likely weekend boosts when new shows open and audiences return to cinemas.</p></li>
<li><p><strong>Rapid Midweek Drop-Off:</strong> Each spike is followed by a steep midweek decline down below $5 000, highlighting how front-loaded daily grosses are concentrated in just a few days.</p></li>
<li><p><strong>Long-Tail Decline:</strong> By early September, daily revenues flatten out near zero, indicating the end of the film’s theatrical lifecycle and its removal from screens.</p></li>
</ul>
<p>First weekend ticket sales</p>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="d8f2853f-2a01-4271-ffe3-a4c2fbb3db87" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_daily.head(<span class="dv">4</span>) <span class="co"># First 4 days (thurs, Fri, Sat, Sun)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> df_daily.iloc[<span class="dv">4</span>:] <span class="co"># the rest of the data</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">daily_gross</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2020-06-26</td>
<td>27670.75</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2020-06-27</td>
<td>35043.16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2020-06-28</td>
<td>40662.80</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2020-06-29</td>
<td>35751.27</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Adding constant line to visualizing every week ticket sales</strong></p>
<div id="cell-19" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>release_date <span class="op">=</span> pd.to_datetime(<span class="st">'2020-06-26'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>last_date <span class="op">=</span> df_daily[<span class="st">'date'</span>].<span class="bu">max</span>()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>week_starts <span class="op">=</span> pd.date_range(start<span class="op">=</span>release_date, end<span class="op">=</span>last_date, freq<span class="op">=</span><span class="st">'7D'</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plt.plot(df_daily[<span class="st">'date'</span>], df_daily[<span class="st">'daily_gross'</span>], label<span class="op">=</span><span class="st">'Daily Gross'</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#dashed vertical lines at each weekly boundary</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ws <span class="kw">in</span> week_starts:</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    plt.axvline(ws, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Total Daily Gross Over Time with weekly contant line"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross ($)"</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.grid(True)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the graph we can visualize the average weekly ticket sales, which shows a steady decline after the first week. But there is a clear pattern of weekly spikes, likely due to weekend showings and new releases. I believe this pattern is common in box-office data, where initial sales are strong but taper off quickly, with occasional boosts from new releases or special events like weekend.</p>
<p><strong>Daily box-office by theatre</strong></p>
<div id="cell-22" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    df_long</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>      .groupby([<span class="st">'date'</span>,<span class="st">'circuit'</span>])[<span class="st">'daily_gross'</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      .<span class="bu">sum</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)         <span class="co"># one column per circuit</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pivot.index</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [pivot[c] <span class="cf">for</span> c <span class="kw">in</span> pivot.columns]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.stackplot(dates, values, labels<span class="op">=</span>pivot.columns)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, title<span class="op">=</span><span class="st">'Circuit'</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Daily Box Office Gross by Circuit Over Time'</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Daily Gross ($)'</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Event, Hoyst and Reading Cinemas make up the majority of the box-office sales, with Event leading by a significant margin. This suggests that these chains have a strong presence in the market and likely attract a large audience share. The data also shows that Event Cinemas has a consistent performance, while Hoyst has more variability in its daily sales. This could indicate different marketing strategies or screening schedules between the two chains. Reading Cinemas, while having lower sales overall, still contributes a notable portion to the total box-office revenue.</p>
<p><strong>Cummulative box-office over time</strong></p>
<div id="cell-25" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df_daily[<span class="st">'cume_gross'</span>] <span class="op">=</span> df_daily[<span class="st">'daily_gross'</span>].cumsum()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">4</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>plt.plot(df_daily[<span class="st">'date'</span>], df_daily[<span class="st">'cume_gross'</span>])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Box Office Gross"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Gross ($)"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It becomes clear that as time progresses, the growth rate slows significantly, reflecting the film’s declining popularity and reduced audience interest. By the end of the period, the cumulative revenue stabilizes, indicating that the film has reached its peak earnings and is nearing the end of its theatrical run. In the end, the movie lasted eleven weeks in theatres, with a total gross of $1,000,000, which can be considered a successful run for a film of this type. It also shows that we have hope in the future for Asian Animation movie.</p>
<p><strong>Total Gross by state</strong></p>
<div id="cell-28" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Aggregating</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>state_totals <span class="op">=</span> (</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    df_long</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'state'</span>)[<span class="st">'daily_gross'</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Bar chart</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>state_totals.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Total Box Office Gross by State"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"State"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Gross ($)"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="time-series-modelling" class="level2">
<h2 class="anchored" data-anchor-id="time-series-modelling"><strong>3. Time Series Modelling</strong></h2>
<p>We reserve the first 14 days for training because it gives the model two full weekly cycles to learn both the underlying upward trend and recurring weekend spikes. With only one week, it’s difficult to distinguish true seasonality from random noise; with two weeks, the Holt–Winters components can reliably estimate level, trend, and seasonality before forecasting beyond day 14.</p>
<section id="simple-exponential-smoothing" class="level3">
<h3 class="anchored" data-anchor-id="simple-exponential-smoothing"><strong>3.1. Simple Exponential smoothing</strong></h3>
<div id="cell-32" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:532}}" data-outputid="5a8848c3-a600-4196-cf8d-4c3ff06fa7e5" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.holtwinters <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>y_full <span class="op">=</span> df_daily[<span class="st">'daily_gross'</span>].values</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Not enough data to learn seasonality from 4 days</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; train on first 14 days, then forecast next 63 days</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y_full[:<span class="dv">14</span>]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>n_forecast <span class="op">=</span> <span class="dv">63</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Holt-Winters with additive seasonality</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ExponentialSmoothing(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span><span class="st">'add'</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    seasonal<span class="op">=</span><span class="st">'add'</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    seasonal_periods<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    initialization_method<span class="op">=</span><span class="st">"estimated"</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> model.fit()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>forecast_add <span class="op">=</span> fit.forecast(n_forecast)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>y_pred_full <span class="op">=</span> np.concatenate([y_train, forecast_add])</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>y_actual <span class="op">=</span> y_full[:<span class="bu">len</span>(y_pred_full)]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>plt.plot(y_full, label<span class="op">=</span><span class="st">'Actual'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>plt.plot(y_pred_full, label<span class="op">=</span><span class="st">'Forecast (Seasonal Holt-Winters)'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="bu">len</span>(y_train)<span class="op">-</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, label<span class="op">=</span><span class="st">'Forecast Start'</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day"</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Forecast with Seasonality (Holt-Winters)"</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>true_total <span class="op">=</span> y_actual.<span class="bu">sum</span>()</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>pred_total <span class="op">=</span> y_pred_full.<span class="bu">sum</span>()</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (Days 1–77): </span><span class="sc">{</span>true_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue: </span><span class="sc">{</span>pred_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🔻 Error: </span><span class="sc">{</span><span class="bu">abs</span>(true_total <span class="op">-</span> pred_total)<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> <span class="bu">abs</span>(true_total <span class="op">-</span> pred_total)<span class="op">/</span>true_total<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Actual Total Revenue (Days 1–77): 1,461,849.46
📈 Predicted Total Revenue: 6,601,758.27
🔻 Error: 5,139,908.81 (351.60%)</code></pre>
</div>
</div>
<p>Oops, looks like we messed up.The Holt–Winters forecast captures the initial surge and weekly spikes, but it fails to account for the long-term upward trend in the data. The model assumes a constant level, which is not appropriate here.</p>
<p><strong>Solution</strong>: Use Holt-Winter Multiplicative trend instead</p>
</section>
<section id="holt-winter-multiplicative-trend" class="level3">
<h3 class="anchored" data-anchor-id="holt-winter-multiplicative-trend">3.2. <strong>Holt-Winter Multiplicative trend</strong></h3>
<div id="cell-35" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:587}}" data-outputid="b78903c6-c18d-4c96-a67e-9bdb0894ec65" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="op">=</span> ExponentialSmoothing(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span><span class="st">'mul'</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    seasonal<span class="op">=</span><span class="st">'mul'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    seasonal_periods<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    initialization_method<span class="op">=</span><span class="st">"estimated"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> model1.fit()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>forecast_mul <span class="op">=</span> fit.forecast(n_forecast)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>y_pred_full <span class="op">=</span> np.concatenate([y_train, forecast_mul])</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>y_actual <span class="op">=</span> y_full[:<span class="bu">len</span>(y_pred_full)]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plt.plot(y_full, label<span class="op">=</span><span class="st">'Actual'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plt.plot(y_pred_full, label<span class="op">=</span><span class="st">'Forecast (Seasonal Holt-Winters)'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="bu">len</span>(y_train)<span class="op">-</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, label<span class="op">=</span><span class="st">'Forecast Start'</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Forecast with Seasonality (Holt-Winters)"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>true_total <span class="op">=</span> y_actual.<span class="bu">sum</span>()</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>pred_total <span class="op">=</span> y_pred_full.<span class="bu">sum</span>()</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (Days 1–77): </span><span class="sc">{</span>true_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue: </span><span class="sc">{</span>pred_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🔻 Error: </span><span class="sc">{</span><span class="bu">abs</span>(true_total <span class="op">-</span> pred_total)<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> <span class="bu">abs</span>(true_total <span class="op">-</span> pred_total)<span class="op">/</span>true_total<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Actual Total Revenue (Days 1–77): 1,461,849.46
📈 Predicted Total Revenue: 1,089,761.14
🔻 Error: 372,088.32 (25.45%)</code></pre>
</div>
</div>
<p>The multiplicative Holt–Winters model delivers a total predicted revenue of $1,290,531 against the actual $1,461,849 (11.7% error). Compared with the additive version, it handles proportional seasonality better—early high‐gross weeks are captured more faithfully—but still systematically underestimates the sharp weekend peaks. Overall accuracy is comparable to the additive method, yet the multiplicative formulation slightly improves fit during the largest peaks at the expense of modest bias in the low‐volume tail.</p>
</section>
<section id="prophet-model-meta" class="level3">
<h3 class="anchored" data-anchor-id="prophet-model-meta"><strong>3.3. Prophet model (Meta)</strong></h3>
<p>Facebook’s Prophet is an open-source forecasting tool designed for time series that exhibit strong seasonal effects and multiple seasonality with irregular historical data (e.g.&nbsp;missing days or outliers). Under the hood, Prophet fits a decomposable model of the form:</p>
<ul>
<li>y(t) = g(t) + s(t) + h(t) + ε(t)</li>
</ul>
<p><strong>g(t)</strong> is a piecewise linear or logistic growth curve that automatically detects changepoints in the trend.</p>
<p><strong>s(t)</strong> captures periodic effects (daily, weekly, yearly) via a set of Fourier series terms.</p>
<p><strong>h(t)</strong> incorporates user-supplied “holiday” or event effects, modeled as additional regressors.</p>
<p><strong>ε(t)</strong> is an error term for unexplained noise.</p>
<p>In practice, we feed Prophet a two-column DataFrame (ds for timestamps, y for values), fit the model, and then call <code>make_future_dataframe + predict</code> to get forecasts along with confidence intervals and decomposed trend/seasonality components. So we have some data transformation work to do</p>
<div id="cell-39" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:567}}" data-outputid="f2bcd41d-0bf2-4dd5-a3ff-4b29fc8b95f8" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophet <span class="im">import</span> Prophet</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Format input to feed prophet model</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>df_prophet <span class="op">=</span> df_daily.copy()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>df_prophet.columns <span class="op">=</span> [<span class="st">'ds'</span>, <span class="st">'y'</span>]  <span class="co"># Prophet needs 'ds' and 'y'</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use only first 14 days for training</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>train_days <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> df_prophet.iloc[:train_days].copy()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Prophet model</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>model2 <span class="op">=</span> Prophet(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    growth<span class="op">=</span><span class="st">'flat'</span>,  <span class="co"># disables trend</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    weekly_seasonality<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    seasonality_mode<span class="op">=</span><span class="st">'multiplicative'</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>model2.fit(df_train)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast next 63 days</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>future <span class="op">=</span> model2.make_future_dataframe(periods<span class="op">=</span><span class="dv">63</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>forecast_proph <span class="op">=</span> model2.predict(future)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot forecast</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> model2.plot(forecast_proph)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>plt.axvline(df_train[<span class="st">'ds'</span>].iloc[<span class="op">-</span><span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'Forecast Start'</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Prophet Forecast: Daily Revenue with Weekly Seasonality"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate prediction</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> forecast_proph[<span class="st">'yhat'</span>].iloc[:<span class="dv">77</span>].values  <span class="co"># limit to 77 days</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> np.clip(y_pred, <span class="dv">0</span>, <span class="va">None</span>)  <span class="co"># ensure no negatives</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> df_prophet[<span class="st">'y'</span>].iloc[:<span class="dv">77</span>].values</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>actual_total <span class="op">=</span> y_true.<span class="bu">sum</span>()</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>predicted_total <span class="op">=</span> y_pred.<span class="bu">sum</span>()</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>error <span class="op">=</span> <span class="bu">abs</span>(actual_total <span class="op">-</span> predicted_total)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (Days 1–77): </span><span class="sc">{</span>actual_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue: </span><span class="sc">{</span>predicted_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"❌ Absolute Error: </span><span class="sc">{</span>error<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> error <span class="op">/</span> actual_total<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Actual Total Revenue (Days 1–77): 1,461,849.46
📈 Predicted Total Revenue: 4,158,807.60
❌ Absolute Error: 2,696,958.14 (184.49%)</code></pre>
</div>
</div>
<p>Prophet clearly captures the strong weekly pattern in the Red Shoes box‐office data, showing a consistent peak every weeks. However, its long-term trend estimate is too optimistic—forecasted peaks hover around 68–70 K while the actual post-launch values decline into the single digits. The unusually wide uncertainty bands reflect Prophet’s caution about limited history (only two weeks of data), but they also admit implausible extremes (25 K–85 K) well beyond observed ranges. Overall, Prophet’s automatic changepoint and seasonality fitting identifies the right cadence, yet without extra data (or informed holiday-like regressors) its level and trend components miss the rapid post-launch decay, leading to severe overestimation.</p>
</section>
<section id="auto-regressive-integrated-moving-average" class="level3">
<h3 class="anchored" data-anchor-id="auto-regressive-integrated-moving-average"><strong>3.4. Auto Regressive Integrated Moving Average</strong></h3>
<p>An <strong>ARIMA</strong> model (AutoRegressive Integrated Moving Average) is a classical, univariate forecasting approach that explicitly models three effects in a stationary or made-stationary time series. The <strong>AR</strong> (autoregressive) part fits relationships between an observation and a specified number of its own past values; the <strong>I</strong> (integrated) part removes non-stationarity by differencing the series one or more times; and the <strong>MA</strong> (moving average) part captures serial correlation in the residual errors by modeling them as a weighted sum of past forecast errors. By choosing appropriate orders (p, d, q) for AR lags, differencing steps, and MA lags—often guided by autocorrelation (ACF) and partial autocorrelation (PACF) plots. To make things a little bit easier, we will import an exissting pakage called <code>auto_arima</code>.</p>
<p><strong>Importing auto_arima</strong></p>
<div id="cell-44" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Install Condacolab to integrate Conda with Colab</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install -q condacolab</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Import and run Condacolab to enable Conda</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># import condacolab</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># condacolab.install()</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Install pmdarima from conda-forge using Conda</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># !conda install -c conda-forge pmdarima -y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Fitting ARIMA model</strong></p>
<div id="cell-46" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:897}}" data-outputid="3d3d1ca6-de19-4bd9-a7b6-d873fd8b99d3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pmdarima <span class="im">as</span> pm</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pmdarima.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pmdarima.arima <span class="im">import</span> auto_arima</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df_daily.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">'daily_gross'</span>].values</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>train_days <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y[:train_days]</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y[train_days:]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>n_forecast <span class="op">=</span> <span class="dv">77</span> <span class="op">-</span> train_days</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit auto ARIMA</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>model3 <span class="op">=</span> auto_arima(</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    seasonal<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    m<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    D<span class="op">=</span><span class="dv">0</span>,  <span class="co"># no seasonal differencing</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    stepwise<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    suppress_warnings<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    error_action<span class="op">=</span><span class="st">'ignore'</span>,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">=</span><span class="va">True</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>forecast_arima <span class="op">=</span> model3.predict(n_periods<span class="op">=</span>n_forecast)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine prediction</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>y_pred_full <span class="op">=</span> np.concatenate([y_train, forecast_arima])</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>y_actual <span class="op">=</span> y[:<span class="dv">77</span>]</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>plt.plot(y_actual, label<span class="op">=</span><span class="st">"Actual"</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>plt.plot(y_pred_full, label<span class="op">=</span><span class="st">"Forecast (Auto ARIMA)"</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>plt.axvline(train_days <span class="op">-</span> <span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, label<span class="op">=</span><span class="st">"Forecast Start"</span>)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day"</span>)</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Auto ARIMA Forecast of Movie Revenue"</span>)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>actual_total <span class="op">=</span> y_actual.<span class="bu">sum</span>()</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>predicted_total <span class="op">=</span> y_pred_full.<span class="bu">sum</span>()</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>error <span class="op">=</span> <span class="bu">abs</span>(actual_total <span class="op">-</span> predicted_total)</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>error_pct <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> error <span class="op">/</span> actual_total</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (77 days): $</span><span class="sc">{</span>actual_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue: $</span><span class="sc">{</span>predicted_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"❌ Absolute Error: $</span><span class="sc">{</span>error<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span>error_pct<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Performing stepwise search to minimize aic
 ARIMA(2,0,2)(1,0,1)[7] intercept   : AIC=inf, Time=1.26 sec
 ARIMA(0,0,0)(0,0,0)[7] intercept   : AIC=312.570, Time=0.02 sec
 ARIMA(1,0,0)(1,0,0)[7] intercept   : AIC=307.673, Time=0.11 sec
 ARIMA(0,0,1)(0,0,1)[7] intercept   : AIC=inf, Time=0.44 sec
 ARIMA(0,0,0)(0,0,0)[7]             : AIC=347.858, Time=0.01 sec
 ARIMA(1,0,0)(0,0,0)[7] intercept   : AIC=305.679, Time=0.02 sec
 ARIMA(1,0,0)(0,0,1)[7] intercept   : AIC=307.120, Time=0.03 sec
 ARIMA(1,0,0)(1,0,1)[7] intercept   : AIC=inf, Time=0.14 sec
 ARIMA(2,0,0)(0,0,0)[7] intercept   : AIC=303.467, Time=0.03 sec
 ARIMA(2,0,0)(1,0,0)[7] intercept   : AIC=305.466, Time=0.05 sec
 ARIMA(2,0,0)(0,0,1)[7] intercept   : AIC=305.073, Time=0.04 sec
 ARIMA(2,0,0)(1,0,1)[7] intercept   : AIC=305.953, Time=0.10 sec
 ARIMA(3,0,0)(0,0,0)[7] intercept   : AIC=306.186, Time=0.05 sec
 ARIMA(2,0,1)(0,0,0)[7] intercept   : AIC=304.331, Time=0.06 sec
 ARIMA(1,0,1)(0,0,0)[7] intercept   : AIC=303.481, Time=0.05 sec
 ARIMA(3,0,1)(0,0,0)[7] intercept   : AIC=306.277, Time=0.08 sec
 ARIMA(2,0,0)(0,0,0)[7]             : AIC=306.034, Time=0.07 sec

Best model:  ARIMA(2,0,0)(0,0,0)[7] intercept
Total fit time: 2.569 seconds</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Actual Total Revenue (77 days): $1,461,849.46
📈 Predicted Total Revenue: $4,135,933.22
❌ Absolute Error: $2,674,083.76 (182.92%)</code></pre>
</div>
</div>
<p>The Auto-ARIMA forecast essentially “locks in” on the latter part of the training period’s mid-range values (around $53–54 K per day) and then projects them almost flatly forward, completely missing both the sharp opening spikes and the deep troughs that follow in the actual data. As a result, it substantially overestimates total revenue (forecast ≈$4.14 M vs.&nbsp;actual ≈$1.46 M) and yields an enormous 183 % absolute error. This illustrates that a plain ARIMA—with no explicit handling of the strong weekly/biweekly seasonality or the sudden dropoffs—is ill-suited to capture the movie roll-out pattern here.</p>
</section>
</section>
<section id="a-weighted-average-combination-of-all-forecast" class="level2">
<h2 class="anchored" data-anchor-id="a-weighted-average-combination-of-all-forecast"><strong>4. A Weighted-Average Combination of all forecast</strong></h2>
<p>We’ve seen that the multiplicative Holt–Winters model is by far the strongest performer (only ~11.7 % total error) while both Prophet and Auto-ARIMA miss the day-of-week peaks and troughs so badly (each &gt;180 % error) that you really don’t want to trust them on their own. By allocating 95 % of your weight to the HW forecast you capture the strong seasonal pattern and trend, then sprinkle in 2.5 % each of Prophet and ARIMA purely to guard against the unlikely event that HW is systematically biased in some segment of the curve. In effect you’re doing an inverse-error weighting—HW gets almost all the say, and the two poorer models get just enough “vote” to soften any extreme systematic mis-calibration without overwhelming the proven HW core.</p>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:567}}" data-outputid="770f0a87-cf38-4ae8-a37c-78046c286197">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>n_forecast <span class="op">=</span> <span class="dv">63</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>prophet_forecast_part <span class="op">=</span> forecast_proph[<span class="st">'yhat'</span>].iloc[<span class="dv">14</span>:<span class="dv">14</span><span class="op">+</span>n_forecast].values</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to numpy arrays</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>forecast_add_np <span class="op">=</span> np.array(forecast_add)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>forecast_mul_np <span class="op">=</span> np.array(forecast_mul)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>prophet_forecast_part_np <span class="op">=</span> np.array(prophet_forecast_part)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>forecast_arima_np <span class="op">=</span> np.array(forecast_arima)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> (<span class="bu">len</span>(forecast_add_np) <span class="op">==</span> <span class="bu">len</span>(forecast_mul_np) <span class="op">==</span> <span class="bu">len</span>(prophet_forecast_part_np) <span class="op">==</span> <span class="bu">len</span>(forecast_arima_np) <span class="op">==</span> n_forecast):</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Warning: Forecast lengths do not match. Cannot average."</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average the forecasts</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    average_forecast <span class="op">=</span> <span class="fl">0.95</span><span class="op">*</span> forecast_mul_np <span class="op">+</span> <span class="fl">0.025</span><span class="op">*</span> prophet_forecast_part_np <span class="op">+</span> <span class="fl">0.025</span><span class="op">*</span> forecast_arima_np</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    y_pred_averaged_full <span class="op">=</span> np.concatenate([y_train, average_forecast])</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    y_actual <span class="op">=</span> y_full[:<span class="bu">len</span>(y_pred_averaged_full)]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    plt.plot(y_actual, label<span class="op">=</span><span class="st">'Actual'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    plt.plot(y_pred_averaged_full, label<span class="op">=</span><span class="st">'Averaged Forecast'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    plt.axvline(<span class="bu">len</span>(y_train)<span class="op">-</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, label<span class="op">=</span><span class="st">'Forecast Start'</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Day"</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Averaged Forecast of Daily Gross (Holt-Winters, Prophet, ARIMA)"</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    actual_total <span class="op">=</span> y_actual.<span class="bu">sum</span>()</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    predicted_total_averaged <span class="op">=</span> y_pred_averaged_full.<span class="bu">sum</span>()</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    error_averaged <span class="op">=</span> <span class="bu">abs</span>(actual_total <span class="op">-</span> predicted_total_averaged)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    error_pct_averaged <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> error_averaged <span class="op">/</span> actual_total</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Averaged Model Evaluation ---"</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (Days 1–77): </span><span class="sc">{</span>actual_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue (Averaged): </span><span class="sc">{</span>predicted_total_averaged<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🔻 Absolute Error (Averaged): </span><span class="sc">{</span>error_averaged<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span>error_pct_averaged<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Averaged Model Evaluation ---
✅ Actual Total Revenue (Days 1–77): 1,461,849.46
📈 Predicted Total Revenue (Averaged): 1,433,374.13
🔻 Absolute Error (Averaged): 28,475.33 (1.95%)</code></pre>
</div>
</div>
<p>By blending 95 % of the proven Holt–Winters with just 2.5 % each of Prophet and ARIMA, your combined forecast slashes the total‐revenue error down to about 1.95 %—more than a five‐fold improvement over Holt–Winters alone (11.7 % error). The heavy HW weighting preserves its accurate weekly peaks and troughs, while the tiny cushions of Prophet and ARIMA gently nudge the baseline so that your aggregated line hugs the blue “actuals” almost perfectly over the entire holdout. In short, the averaging model leverages HW’s strength while using the other two models only as a minimal bias correction, producing a near‐ideal fit without over-smoothing true seasonal spikes.</p>
</section>
<section id="implementation-of-the-averaging-model" class="level2">
<h2 class="anchored" data-anchor-id="implementation-of-the-averaging-model"><strong>5. Implementation of the Averaging Model</strong></h2>
<p>To actually use this model in the validation set, we need to rewrite the python code in a class so that we could later fit and predict</p>
<p><strong>Implementation of the Averaging Model with OOP</strong></p>
<div id="cell-55" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, RegressorMixin</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WeightedAveragingTimeSeriesModel(BaseEstimator, RegressorMixin): <span class="co"># Inheritance</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_prophet, model_hw, model_arima, weights<span class="op">=</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>), forecast_horizon<span class="op">=</span><span class="dv">63</span>):</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_prophet <span class="op">=</span> model_prophet</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_hw <span class="op">=</span> model_hw</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_arima <span class="op">=</span> model_arima</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weights <span class="op">=</span> weights</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast_horizon <span class="op">=</span> forecast_horizon</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y_train <span class="op">=</span> <span class="va">None</span> <span class="co"># Store training data</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, y_train):</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fits each model to the provided training data."""</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y_train <span class="op">=</span> y_train</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        df_prophet <span class="op">=</span> pd.DataFrame({</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ds'</span>: pd.date_range(start<span class="op">=</span>pd.Timestamp.today(), periods<span class="op">=</span><span class="bu">len</span>(y_train), freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'y'</span>: y_train.values</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_prophet.fit(df_prophet)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Holt-Winters fit</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The training data is passed during initialization of ExponentialSmoothing</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The fit method is called without arguments</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_hw_fit <span class="op">=</span> <span class="va">self</span>.model_hw.fit()</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ARIMA fit</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The training data is passed during initialization of auto_arima</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The fit method is called without arguments</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_arima_fit <span class="op">=</span> <span class="va">self</span>.model_arima.fit(<span class="va">self</span>.y_train)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>):</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generates a weighted forecast for the next N days."""</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prophet forecast</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        future_df <span class="op">=</span> <span class="va">self</span>.model_prophet.make_future_dataframe(periods<span class="op">=</span><span class="va">self</span>.forecast_horizon)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        forecast_df <span class="op">=</span> <span class="va">self</span>.model_prophet.predict(future_df)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        forecast_prophet <span class="op">=</span> forecast_df[<span class="st">'yhat'</span>].iloc[<span class="op">-</span><span class="va">self</span>.forecast_horizon:].values.reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Holt-Winters forecast</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        forecast_hw <span class="op">=</span> np.array(<span class="va">self</span>.model_hw_fit.forecast(<span class="va">self</span>.forecast_horizon)).reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ARIMA forecast</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        forecast_arima <span class="op">=</span> np.array(<span class="va">self</span>.model_arima_fit.predict(n_periods<span class="op">=</span><span class="va">self</span>.forecast_horizon)).reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align lengths just in case</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> forecast_prophet.shape[<span class="dv">0</span>] <span class="op">==</span> <span class="va">self</span>.forecast_horizon</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> forecast_hw.shape[<span class="dv">0</span>] <span class="op">==</span> <span class="va">self</span>.forecast_horizon</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> forecast_arima.shape[<span class="dv">0</span>] <span class="op">==</span> <span class="va">self</span>.forecast_horizon</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weighted average</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        forecasts <span class="op">=</span> np.vstack([forecast_prophet, forecast_hw, forecast_arima])</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        weighted_avg <span class="op">=</span> np.average(forecasts, axis<span class="op">=</span><span class="dv">0</span>, weights<span class="op">=</span><span class="va">self</span>.weights)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        y_pred_averaged_full <span class="op">=</span> np.concatenate([<span class="va">self</span>.y_train, weighted_avg])</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y_pred_averaged_full</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Instantiating the models instances</strong></p>
<div id="cell-57" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="2824ed09-d15b-4cf1-a092-c8e0c6eebf20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="op">=</span> ExponentialSmoothing(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span><span class="st">'mul'</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    seasonal<span class="op">=</span><span class="st">'mul'</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    seasonal_periods<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    initialization_method<span class="op">=</span><span class="st">"estimated"</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>model2 <span class="op">=</span> Prophet(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    growth<span class="op">=</span><span class="st">'flat'</span>,  <span class="co"># disables trend</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    weekly_seasonality<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    seasonality_mode<span class="op">=</span><span class="st">'multiplicative'</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>model3 <span class="op">=</span> auto_arima(</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    seasonal<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    m<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    D<span class="op">=</span><span class="dv">0</span>,  <span class="co"># no seasonal differencing</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    stepwise<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    suppress_warnings<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    error_action<span class="op">=</span><span class="st">'ignore'</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">=</span><span class="va">True</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Performing stepwise search to minimize aic
 ARIMA(2,0,2)(1,0,1)[7] intercept   : AIC=inf, Time=0.35 sec
 ARIMA(0,0,0)(0,0,0)[7] intercept   : AIC=312.570, Time=0.01 sec
 ARIMA(1,0,0)(1,0,0)[7] intercept   : AIC=307.673, Time=0.03 sec
 ARIMA(0,0,1)(0,0,1)[7] intercept   : AIC=inf, Time=0.08 sec
 ARIMA(0,0,0)(0,0,0)[7]             : AIC=347.858, Time=0.01 sec
 ARIMA(1,0,0)(0,0,0)[7] intercept   : AIC=305.679, Time=0.02 sec
 ARIMA(1,0,0)(0,0,1)[7] intercept   : AIC=307.120, Time=0.03 sec
 ARIMA(1,0,0)(1,0,1)[7] intercept   : AIC=inf, Time=0.17 sec
 ARIMA(2,0,0)(0,0,0)[7] intercept   : AIC=303.467, Time=0.02 sec
 ARIMA(2,0,0)(1,0,0)[7] intercept   : AIC=305.466, Time=0.05 sec
 ARIMA(2,0,0)(0,0,1)[7] intercept   : AIC=305.073, Time=0.04 sec
 ARIMA(2,0,0)(1,0,1)[7] intercept   : AIC=305.953, Time=0.10 sec
 ARIMA(3,0,0)(0,0,0)[7] intercept   : AIC=306.186, Time=0.05 sec
 ARIMA(2,0,1)(0,0,0)[7] intercept   : AIC=304.331, Time=0.05 sec
 ARIMA(1,0,1)(0,0,0)[7] intercept   : AIC=303.481, Time=0.04 sec
 ARIMA(3,0,1)(0,0,0)[7] intercept   : AIC=306.277, Time=0.06 sec
 ARIMA(2,0,0)(0,0,0)[7]             : AIC=306.034, Time=0.08 sec

Best model:  ARIMA(2,0,0)(0,0,0)[7] intercept
Total fit time: 1.206 seconds</code></pre>
</div>
</div>
<p><strong>Making predictions</strong></p>
<div id="cell-59" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:656}}" data-outputid="da204de6-4dc1-41ba-baa1-2e76f013b2d5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the weights for each model</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> (<span class="fl">0.025</span>, <span class="fl">0.95</span>, <span class="fl">0.025</span>) <span class="co"># Prophet, Holt-Winters mul, ARIMA</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>weighted_model <span class="op">=</span> WeightedAveragingTimeSeriesModel(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    model_prophet<span class="op">=</span>model2,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    model_hw<span class="op">=</span>model1,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    model_arima<span class="op">=</span>model3,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    weights<span class="op">=</span>weights,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    forecast_horizon<span class="op">=</span>n_forecast</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>weighted_model.fit(df_daily[<span class="st">'daily_gross'</span>].iloc[:<span class="dv">14</span>])</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>averaged_forecast_series <span class="op">=</span> weighted_model.predict()</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>plt.plot(y_actual, label<span class="op">=</span><span class="st">'Actual'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>plt.plot(y_pred_averaged_full, label<span class="op">=</span><span class="st">'Averaged Forecast'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="bu">len</span>(y_train)<span class="op">-</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, label<span class="op">=</span><span class="st">'Forecast Start'</span>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day"</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Gross"</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Averaged Forecast of Daily Gross (Holt-Winters, Prophet, ARIMA)"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>actual_total <span class="op">=</span> y_actual.<span class="bu">sum</span>()</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>predicted_total_averaged <span class="op">=</span> y_pred_averaged_full.<span class="bu">sum</span>()</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>error_averaged <span class="op">=</span> <span class="bu">abs</span>(actual_total <span class="op">-</span> predicted_total_averaged)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>error_pct_averaged <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> error_averaged <span class="op">/</span> actual_total</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Averaged Model Evaluation ---"</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Actual Total Revenue (Days 1–77): </span><span class="sc">{</span>actual_total<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📈 Predicted Total Revenue (Averaged): </span><span class="sc">{</span>predicted_total_averaged<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🔻 Absolute Error (Averaged): </span><span class="sc">{</span>error_averaged<span class="sc">:,.2f}</span><span class="ss"> (</span><span class="sc">{</span>error_pct_averaged<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Averaged Model Evaluation ---
✅ Actual Total Revenue (Days 1–77): 1,461,849.46
📈 Predicted Total Revenue (Averaged): 1,433,374.13
🔻 Absolute Error (Averaged): 28,475.33 (1.95%)</code></pre>
</div>
</div>
<p>Bamm! we got ourselves an averaging model. This will allow us to easily extend the model in the future, for example, by adding more models or changing the weights. The model is also very easy to use, as we just need to call the <code>fit</code> and <code>predict</code> methods. We will use this on our validation set to see how well it performs.</p>
</section>
<section id="another-machine-learning-approach-to-sale-forecasting" class="level2">
<h2 class="anchored" data-anchor-id="another-machine-learning-approach-to-sale-forecasting"><strong>6. Another machine learning approach to sale forecasting</strong></h2>
<p>Previously, we modeled daily sales with time-series methods and summed weekly forecasts to estimate total revenue. However, if our goal is simply to predict total sales, it may be more efficient to derive a single scaling factor based solely on the first four days’ data.</p>
<p>To do this, we’ll gather data and then train on 200 movies to try and predict the total sales using only the first 4 days of box office.</p>
<p><strong>Load Dataset</strong></p>
<div id="cell-64" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:911}}" data-outputid="7bc4c4af-4b02-4540-9c95-817ef2a17053">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(<span class="st">'filtered_animation_data.xlsx'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Rank</th>
<th data-quarto-table-cell-role="th">Film Code</th>
<th data-quarto-table-cell-role="th">Title</th>
<th data-quarto-table-cell-role="th">Distributor</th>
<th data-quarto-table-cell-role="th">Release Date</th>
<th data-quarto-table-cell-role="th">Rating</th>
<th data-quarto-table-cell-role="th">Genre1</th>
<th data-quarto-table-cell-role="th">Genre2</th>
<th data-quarto-table-cell-role="th">Genre3</th>
<th data-quarto-table-cell-role="th">Country1</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Opening\nWeekend\nScreens</th>
<th data-quarto-table-cell-role="th">Opening\nWeekend\nTheatres</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nGross</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nScreens</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nTheatres</th>
<th data-quarto-table-cell-role="th">% of\nOpening\nWeekend\nto Week</th>
<th data-quarto-table-cell-role="th">Lifetime\nmultiple of\nOpening\nWeekend</th>
<th data-quarto-table-cell-role="th">Lifetime\nmultiple of\nOpening\nWeek</th>
<th data-quarto-table-cell-role="th">Min\nScreens</th>
<th data-quarto-table-cell-role="th">Max\nScreens</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>19</td>
<td>FADFP5Q7TAM</td>
<td>Pokemon: The First Movie</td>
<td>Warner Bros.</td>
<td>1999-12-16</td>
<td>G</td>
<td>Action</td>
<td>Adventure</td>
<td>Family</td>
<td>Japan</td>
<td>...</td>
<td>294.0</td>
<td>NaN</td>
<td>3245864.00</td>
<td>294.0</td>
<td>NaN</td>
<td>62%</td>
<td>3.761379</td>
<td>2.341542</td>
<td>294.0</td>
<td>294.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>20</td>
<td>FADFP76VRME</td>
<td>Ne Zha 2</td>
<td>CMC Pictures</td>
<td>2025-02-13</td>
<td>M</td>
<td>Drama</td>
<td>Comedy</td>
<td>Action</td>
<td>China</td>
<td>...</td>
<td>125.0</td>
<td>91.0</td>
<td>3107231.88</td>
<td>125.0</td>
<td>92.0</td>
<td>76%</td>
<td>3.211846</td>
<td>2.425894</td>
<td>1.0</td>
<td>136.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>21</td>
<td>FADFP4O5MTI</td>
<td>Boy and the Heron, The</td>
<td>Sony</td>
<td>2023-12-07</td>
<td>PG</td>
<td>Adventure</td>
<td>Family</td>
<td>Drama</td>
<td>Japan</td>
<td>...</td>
<td>210.0</td>
<td>210.0</td>
<td>1690939.00</td>
<td>217.0</td>
<td>210.0</td>
<td>69%</td>
<td>4.327335</td>
<td>3.000681</td>
<td>1.0</td>
<td>225.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>22</td>
<td>FADFP4VPBXE</td>
<td>Pokemon 2000</td>
<td>Warner Bros.</td>
<td>2000-09-07</td>
<td>G</td>
<td>Animated</td>
<td>Fantasy</td>
<td>NaN</td>
<td>Japan</td>
<td>...</td>
<td>85.0</td>
<td>NaN</td>
<td>454185.00</td>
<td>85.0</td>
<td>NaN</td>
<td>35%</td>
<td>29.477023</td>
<td>10.210861</td>
<td>85.0</td>
<td>85.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>23</td>
<td>FADFP4XKPTE</td>
<td>Demon Slayer the Movie: Mugen Train</td>
<td>Madman</td>
<td>2021-02-25</td>
<td>MA15+</td>
<td>Action</td>
<td>Adventure</td>
<td>Animated</td>
<td>Japan</td>
<td>...</td>
<td>201.0</td>
<td>168.0</td>
<td>2266066.00</td>
<td>193.0</td>
<td>168.0</td>
<td>82%</td>
<td>2.380472</td>
<td>1.957368</td>
<td>1.0</td>
<td>193.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 37 columns</p>
</div>
</div>
</div>
<p><strong>Make sure all training movies are realeased on Thursday</strong></p>
<div id="cell-66" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:498}}" data-outputid="fb5f0a85-4404-46bd-d51a-100ecfbdbd4b">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'Release Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Release Date'</span>])</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for films released on a Thursday (weekday() returns 3 for Thursday)</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">'Opening</span><span class="ch">\n</span><span class="st">Day'</span>] <span class="op">==</span> <span class="st">'Thursday'</span>].copy()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Films released on a Thursday:"</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>display(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Films released on a Thursday:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="df-69f82d2a-15eb-4893-bb5b-28f4c6e6d667" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Rank</th>
<th data-quarto-table-cell-role="th">Film Code</th>
<th data-quarto-table-cell-role="th">Title</th>
<th data-quarto-table-cell-role="th">Distributor</th>
<th data-quarto-table-cell-role="th">Release Date</th>
<th data-quarto-table-cell-role="th">Rating</th>
<th data-quarto-table-cell-role="th">Genre1</th>
<th data-quarto-table-cell-role="th">Genre2</th>
<th data-quarto-table-cell-role="th">Genre3</th>
<th data-quarto-table-cell-role="th">Country1</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Opening\nWeekend\nScreens</th>
<th data-quarto-table-cell-role="th">Opening\nWeekend\nTheatres</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nGross</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nScreens</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nTheatres</th>
<th data-quarto-table-cell-role="th">% of\nOpening\nWeekend\nto Week</th>
<th data-quarto-table-cell-role="th">Lifetime\nmultiple of\nOpening\nWeekend</th>
<th data-quarto-table-cell-role="th">Lifetime\nmultiple of\nOpening\nWeek</th>
<th data-quarto-table-cell-role="th">Min\nScreens</th>
<th data-quarto-table-cell-role="th">Max\nScreens</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>19</td>
<td>FADFP5Q7TAM</td>
<td>Pokemon: The First Movie</td>
<td>Warner Bros.</td>
<td>1999-12-16</td>
<td>G</td>
<td>Action</td>
<td>Adventure</td>
<td>Family</td>
<td>Japan</td>
<td>...</td>
<td>294.0</td>
<td>NaN</td>
<td>3245864.00</td>
<td>294.0</td>
<td>NaN</td>
<td>62%</td>
<td>3.761379</td>
<td>2.341542</td>
<td>294.0</td>
<td>294.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>20</td>
<td>FADFP76VRME</td>
<td>Ne Zha 2</td>
<td>CMC Pictures</td>
<td>2025-02-13</td>
<td>M</td>
<td>Drama</td>
<td>Comedy</td>
<td>Action</td>
<td>China</td>
<td>...</td>
<td>125.0</td>
<td>91.0</td>
<td>3107231.88</td>
<td>125.0</td>
<td>92.0</td>
<td>76%</td>
<td>3.211846</td>
<td>2.425894</td>
<td>1.0</td>
<td>136.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>21</td>
<td>FADFP4O5MTI</td>
<td>Boy and the Heron, The</td>
<td>Sony</td>
<td>2023-12-07</td>
<td>PG</td>
<td>Adventure</td>
<td>Family</td>
<td>Drama</td>
<td>Japan</td>
<td>...</td>
<td>210.0</td>
<td>210.0</td>
<td>1690939.00</td>
<td>217.0</td>
<td>210.0</td>
<td>69%</td>
<td>4.327335</td>
<td>3.000681</td>
<td>1.0</td>
<td>225.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>22</td>
<td>FADFP4VPBXE</td>
<td>Pokemon 2000</td>
<td>Warner Bros.</td>
<td>2000-09-07</td>
<td>G</td>
<td>Animated</td>
<td>Fantasy</td>
<td>NaN</td>
<td>Japan</td>
<td>...</td>
<td>85.0</td>
<td>NaN</td>
<td>454185.00</td>
<td>85.0</td>
<td>NaN</td>
<td>35%</td>
<td>29.477023</td>
<td>10.210861</td>
<td>85.0</td>
<td>85.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>23</td>
<td>FADFP4XKPTE</td>
<td>Demon Slayer the Movie: Mugen Train</td>
<td>Madman</td>
<td>2021-02-25</td>
<td>MA15+</td>
<td>Action</td>
<td>Adventure</td>
<td>Animated</td>
<td>Japan</td>
<td>...</td>
<td>201.0</td>
<td>168.0</td>
<td>2266066.00</td>
<td>193.0</td>
<td>168.0</td>
<td>82%</td>
<td>2.380472</td>
<td>1.957368</td>
<td>1.0</td>
<td>193.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 37 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-69f82d2a-15eb-4893-bb5b-28f4c6e6d667')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-69f82d2a-15eb-4893-bb5b-28f4c6e6d667 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-69f82d2a-15eb-4893-bb5b-28f4c6e6d667');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-81622a1a-aa5c-4096-87f1-5acf7d6d9d5f">
      <button class="colab-df-quickchart" onclick="quickchart('df-81622a1a-aa5c-4096-87f1-5acf7d6d9d5f')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-81622a1a-aa5c-4096-87f1-5acf7d6d9d5f button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<p><strong>Create a new dataframe</strong></p>
<div id="cell-68" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-outputid="eed55267-c9c9-407d-eb5a-8978cced9db9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new DataFrame with the desired columns</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>movie_gross_df <span class="op">=</span> df[[<span class="st">'Title'</span>, <span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>, <span class="st">'Lifetime</span><span class="ch">\n</span><span class="st">Gross'</span>]].copy()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>movie_gross_df_cleaned <span class="op">=</span> movie_gross_df.dropna(subset<span class="op">=</span>[<span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>, <span class="st">'Lifetime</span><span class="ch">\n</span><span class="st">Gross'</span>]).copy()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>display(movie_gross_df_cleaned.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="df-fe4496b9-0a63-4bc9-b075-38d7f7108488" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Title</th>
<th data-quarto-table-cell-role="th">Opening\nWeek\nGross</th>
<th data-quarto-table-cell-role="th">Lifetime\nGross</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pokemon: The First Movie</td>
<td>3245864.00</td>
<td>7600326.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Ne Zha 2</td>
<td>3107231.88</td>
<td>7537816.14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Boy and the Heron, The</td>
<td>1690939.00</td>
<td>5073969.28</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Pokemon 2000</td>
<td>454185.00</td>
<td>4637620.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Demon Slayer the Movie: Mugen Train</td>
<td>2266066.00</td>
<td>4435524.13</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-fe4496b9-0a63-4bc9-b075-38d7f7108488')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-fe4496b9-0a63-4bc9-b075-38d7f7108488 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-fe4496b9-0a63-4bc9-b075-38d7f7108488');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-dab0af47-a1d0-46e2-b185-232615cc7ffb">
      <button class="colab-df-quickchart" onclick="quickchart('df-dab0af47-a1d0-46e2-b185-232615cc7ffb')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-dab0af47-a1d0-46e2-b185-232615cc7ffb button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<p><strong>Visualisation</strong></p>
<div id="cell-70" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:564}}" data-outputid="809aa99b-4c28-4969-8399-5d2a580205c1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data<span class="op">=</span>movie_gross_df_cleaned, x<span class="op">=</span><span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>, y<span class="op">=</span><span class="st">'Lifetime</span><span class="ch">\n</span><span class="st">Gross'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Opening Week Gross vs. Lifetime Gross'</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Opening Week Gross'</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Lifetime Gross'</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the scatter plot, wee can clearly see a linear trends between total box office and opening weekend gross. Does that say anything?</p>
<section id="feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering"><strong>6.1 Feature Engineering</strong></h3>
<section id="skewness-and-normalizing-variable" class="level4">
<h4 class="anchored" data-anchor-id="skewness-and-normalizing-variable"><strong>Skewness and Normalizing Variable</strong></h4>
<p>Normal distribution is one of the assumption that linear regression relies on. Therefore, transfoming skewed data will help our models perform better.</p>
<p>First, let’s examine the target variable SalePrice with Distribution plot and Quantile-Quantile plot. I will create a function that will plot both of these plots for us.</p>
<div id="cell-75" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normality_plot(X):</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Draw distribution plot with normal distribution fitted curve</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Draw Quantile-Quantile plot</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If X is a DataFrame with one column, extract the Series</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(X, pd.DataFrame) <span class="kw">and</span> X.shape[<span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> X.iloc[:, <span class="dv">0</span>]</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, (pd.Series, np.ndarray)):</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">"Input X must be a pandas Series, numpy array, or a pandas DataFrame with a single column"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    sns.histplot(X, kde<span class="op">=</span><span class="va">True</span>, stat<span class="op">=</span><span class="st">"density"</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>]) <span class="co"># Use histplot for distribution</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(x<span class="op">=</span>np.linspace(X.<span class="bu">min</span>(), X.<span class="bu">max</span>(), <span class="dv">100</span>), y<span class="op">=</span>norm.pdf(np.linspace(X.<span class="bu">min</span>(), X.<span class="bu">max</span>(), <span class="dv">100</span>), X.mean(), X.std()), color<span class="op">=</span><span class="st">'red'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>])</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Distribution Plot'</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    stats.probplot(X, plot<span class="op">=</span>axes[<span class="dv">1</span>]) <span class="co"># Pass the axes object to probplot</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Q-Q Plot'</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One of the methods to normalize right-skewed data is using log transformation because big values will be pulled to the center. However, log(0) is Nan, so I will use log(1+X) to fix skewness instead.</p>
<div id="cell-77" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="8688ac4a-46dc-44d4-ec9d-f1b1c0575d98">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>normality_plot(np.log(<span class="dv">1</span> <span class="op">+</span> movie_gross_df_cleaned[<span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-78" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="a22627dd-fe8e-4cb9-b10a-f9dc833f58ee">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>normality_plot(np.log(<span class="dv">1</span> <span class="op">+</span> movie_gross_df_cleaned[<span class="st">'Lifetime</span><span class="ch">\n</span><span class="st">Gross'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="document_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Great, now we have a more normal distribution of SalePrice.</p>
<div id="cell-80" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span>  np.log(<span class="dv">1</span> <span class="op">+</span> movie_gross_df_cleaned[[<span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>]])</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span>  np.log(<span class="dv">1</span> <span class="op">+</span> movie_gross_df_cleaned[[<span class="st">'Lifetime</span><span class="ch">\n</span><span class="st">Gross'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="train-test-split" class="level4">
<h4 class="anchored" data-anchor-id="train-test-split"><strong>Train-Test Split</strong></h4>
<div id="cell-82" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="ad6a8bfb-85b4-43a6-ac06-650f009191a3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Train test split</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"X_train.shape:"</span>, X_train.shape)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"X_test.shape:"</span>, X_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>X_train.shape: (109, 1)
X_test.shape: (28, 1)</code></pre>
</div>
</div>
</section>
</section>
<section id="modelling" class="level3">
<h3 class="anchored" data-anchor-id="modelling"><strong>6.2 Modelling</strong></h3>
<section id="cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="cross-validation"><strong>Cross Validation</strong></h4>
<p>In model evaluation, it’s a common practice to split the entire training data into 2 sets of data (train and test). However, a model may work very well on a set of test data but have a poor performance on other sets of unseen data.</p>
<p>A solution to this problem is a procedure called cross-validation (CV). In the example below, under the basic approach, called k-fold CV, the training set is split into 5 smaller sets. Then, for each fold, a model is trained using the other 4 folds and evaluated on the remaining fold. The performance measure reported by k-fold cross-validation is then the average of the values computed in the loop.</p>
<p><img src="cv-1.png" alt="Cross Validation" width="600" align="center"></p>
<p>I will write a function to get the <strong>Root Mean Squared Logarithmic Error (RMSLE)</strong> for my models using cross-validation. There is one note here: because I have transformed the target variable to log(1+y) , the Mean Squared Error for log(1+y) is the Mean Squared Logarithmic Error for SalePrice.</p>
<div id="cell-88" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold, cross_val_score</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getRMSLE(model):</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the average RMSLE over all folds of training data.</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set KFold to shuffle data before the split</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    kf <span class="op">=</span> KFold(n_folds, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get RMSLE score</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(<span class="op">-</span>cross_val_score(</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        model, X_train, y_train, scoring<span class="op">=</span><span class="st">"neg_mean_squared_error"</span>, cv<span class="op">=</span>kf)) <span class="co"># Corrected y to y_train</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rmse.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="linear-regression" class="level4">
<h4 class="anchored" data-anchor-id="linear-regression"><strong>6.2.1 Linear Regression</strong></h4>
<p>Training and get error</p>
<div id="cell-91" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="a905850c-d180-4bc9-eee7-5006ab1b8d34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>model_lr <span class="op">=</span> LinearRegression()</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>getRMSLE(model_lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>np.float64(1.152399384378426)</code></pre>
</div>
</div>
</section>
<section id="xgboost" class="level4">
<h4 class="anchored" data-anchor-id="xgboost"><strong>6.2.2 XGBoost</strong></h4>
<p>Following this <a href="https://www.analyticsvidhya.com/blog/2016/03/complete-guide-parameter-tuning-xgboost-with-codes-python/?fbclid=IwAR1NTAXqgYzjOOFw3qOV5DrcItwNoM73iPvWggnuyVR1PbvORiEUjRunipo">guide</a> of parameter tuning for XGBoost.</p>
<p>Training and get error</p>
<div id="cell-95" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="f2fbed7e-c8d0-4dd9-c483-c9257398854f">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>xgb <span class="op">=</span> XGBRegressor(learning_rate<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                   n_estimators<span class="op">=</span><span class="dv">2100</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                   max_depth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                   min_child_weight<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                   gamma<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                   subsample<span class="op">=</span><span class="fl">0.65</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                   colsample_bytree<span class="op">=</span><span class="fl">0.46</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                   nthread<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                   scale_pos_weight<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                   reg_alpha<span class="op">=</span><span class="fl">0.464</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>                   reg_lambda<span class="op">=</span><span class="fl">0.8571</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                   silent<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>                   random_state<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>                   n_jobs<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>getRMSLE(xgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>np.float64(1.0361711122652482)</code></pre>
</div>
</div>
</section>
<section id="lightgbm" class="level4">
<h4 class="anchored" data-anchor-id="lightgbm"><strong>6.2.3 LightGBM</strong></h4>
<p>LightGBM is a powerful gradient boosting framework based on decision tree algorithm. Like XGBoost, LightGBM has a high performance on large data sets but much faster training speed than XGBoost does. Following this <a href="https://www.analyticsvidhya.com/blog/2017/06/which-algorithm-takes-the-crown-light-gbm-vs-xgboost/?fbclid=IwAR3uYr9U1VDaqh_jEn1cjvMyjEWVHKMaDm_Q9yD1y08OkGBywRR0qpuhhtw">guide</a>, I have tuned the parameters</p>
<p>Training and get error</p>
<div id="cell-99" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="d2dda931-8dc2-4bd1-b9d1-398609c01224">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMRegressor</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>lgb <span class="op">=</span> LGBMRegressor(objective<span class="op">=</span><span class="st">'regression'</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                    learning_rate<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                    n_estimators<span class="op">=</span><span class="dv">730</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                    num_leaves<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                    min_data_in_leaf<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                    max_depth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                    max_bin<span class="op">=</span><span class="dv">55</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                    bagging_fraction<span class="op">=</span><span class="fl">0.78</span>,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                    bagging_freq<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                    feature_fraction<span class="op">=</span><span class="fl">0.24</span>,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>                    feature_fraction_seed<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                    bagging_seed<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                    min_sum_hessian_in_leaf<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                    verbosity <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>getRMSLE(lgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>np.float64(0.9542474539985759)</code></pre>
</div>
</div>
</section>
</section>
<section id="averaging-model" class="level3">
<h3 class="anchored" data-anchor-id="averaging-model"><strong>6.3 Averaging Model</strong></h3>
<p><strong>Implementing the Averaging Model using class</strong></p>
<div id="cell-102" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, RegressorMixin, TransformerMixin, clone</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AveragingModel(BaseEstimator, RegressorMixin, TransformerMixin):</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, models):</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> models</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y):</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create clone models</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models_ <span class="op">=</span> [clone(x) <span class="cf">for</span> x <span class="kw">in</span> <span class="va">self</span>.models]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train cloned models</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model <span class="kw">in</span> <span class="va">self</span>.models_:</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>            model.fit(X, y)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get predictions from trained clone models</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.column_stack(</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>            [model.predict(X) <span class="cf">for</span> model <span class="kw">in</span> <span class="va">self</span>.models_])</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return average predictions</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(predictions, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Training and get error</p>
<div id="cell-104" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="fcebf40e-ff77-4e70-a6d8-dc8e66bf710c">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>avg_model <span class="op">=</span> AveragingModel(models<span class="op">=</span>(model_lr, xgb, lgb))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>getRMSLE(avg_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>np.float64(1.0034316569625248)</code></pre>
</div>
</div>
</section>
<section id="making-prediction" class="level3">
<h3 class="anchored" data-anchor-id="making-prediction"><strong>6.4 Making Prediction</strong></h3>
<p><strong>Fitting the model</strong></p>
<div id="cell-107" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>my_model <span class="op">=</span> avg_model</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>my_model.fit(X_train, y_train)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> my_model.predict(X_test)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>final_predictions <span class="op">=</span> np.exp(predictions) <span class="op">-</span> <span class="dv">1</span> <span class="co"># re scale prediction</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Making prediction on the validation set</p>
<div id="cell-109" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="efb0a878-8c09-4952-833d-367b42b36e4f">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> final_predictions</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> np.exp(y_test) <span class="op">-</span> <span class="dv">1</span> <span class="co"># re scale y_true</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_true, y_pred))</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_true, y_pred)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Root Mean Squared Error (RMSE): </span><span class="sc">{</span>rmse<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean Absolute Error (MAE): </span><span class="sc">{</span>mae<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root Mean Squared Error (RMSE): 350783.46
Mean Absolute Error (MAE): 139605.89</code></pre>
</div>
</div>
<p>We can see that on average the model’s predictions vary from the actual value about 350,000 AUD.</p>
<p><strong>Making prediction using the first week sales of Red Shoes data</strong></p>
<div id="cell-112" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="ae4f8400-4ac6-49aa-f9ad-f975a4089243">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the first 4 days</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>red_shoes_first_4_days_gross <span class="op">=</span> df_daily[<span class="st">'daily_gross'</span>].iloc[:<span class="dv">4</span>].<span class="bu">sum</span>()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Log Transforming</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>X_red_shoes <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> pd.DataFrame([red_shoes_first_4_days_gross], columns<span class="op">=</span>[<span class="st">'Opening</span><span class="ch">\n</span><span class="st">Week</span><span class="ch">\n</span><span class="st">Gross'</span>]))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>predicted_red_shoes_lifetime_gross_log <span class="op">=</span> my_model.predict(X_red_shoes)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse transform and error calculation</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>predicted_red_shoes_lifetime_gross <span class="op">=</span> np.exp(predicted_red_shoes_lifetime_gross_log) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Lifetime Gross for Red Shoes: $</span><span class="sc">{</span>predicted_red_shoes_lifetime_gross[<span class="dv">0</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Predicted Lifetime Gross for Red Shoes (based on first 4 days): $392,028.19</code></pre>
</div>
</div>
<p>Calculate error</p>
<div id="cell-114" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="12b1d753-0f45-4de6-fa3c-848fb0d6e5b5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the actual lifetime gross</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>actual_red_shoes_lifetime_gross <span class="op">=</span> df_daily[<span class="st">'daily_gross'</span>].<span class="bu">sum</span>()</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>predicted_red_shoes_lifetime_gross <span class="op">=</span> predicted_red_shoes_lifetime_gross[<span class="dv">0</span>]</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate error</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>rmse_red_shoes <span class="op">=</span> np.sqrt(mean_squared_error([actual_red_shoes_lifetime_gross], [predicted_red_shoes_lifetime_gross]))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>mae_red_shoes <span class="op">=</span> mean_absolute_error([actual_red_shoes_lifetime_gross], [predicted_red_shoes_lifetime_gross])</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual Lifetime Gross for Red Shoes: $</span><span class="sc">{</span>actual_red_shoes_lifetime_gross<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Lifetime Gross for Red Shoes (based on first 4 days): $</span><span class="sc">{</span>predicted_red_shoes_lifetime_gross<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Root Mean Squared Error (RMSE) for Red Shoes prediction: </span><span class="sc">{</span>rmse_red_shoes<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean Absolute Error (MAE) for Red Shoes prediction: </span><span class="sc">{</span>mae_red_shoes<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Actual Lifetime Gross for Red Shoes: $1,461,849.46
Predicted Lifetime Gross for Red Shoes (based on first 4 days): $392,028.19
Root Mean Squared Error (RMSE) for Red Shoes prediction: 1069821.27
Mean Absolute Error (MAE) for Red Shoes prediction: 1069821.27</code></pre>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion"><strong>Conclusion</strong></h2>
<p>In this project, I have conducted a detailed EDA to understand the data and box office seasonalities of the movie <code>Red Shoes and the 7 dwafs</code>. Based on exploratory analysis, I performed data preprocessing and feature engineering. Finally, I train a simple linear regression models, XGBoost and LightGBM, and take average predictions from these models to predict the life time gross of the testing movies. By the time I write this notebook, my best model has Root Mean Square Error of 1069821.27$</p>
<p>Some key assumeptions and limitations of the time-series approach:</p>
<ul>
<li>The dataset is assumed to be representative of the box-office trends for realased Asian animated films in Australia. The analysis focuses on the film “Red Shoes and the 7 Dwarfs” and may not generalize to other films or genres.</li>
<li>The models used in this project are based on historical data and may not account for future changes in audience preferences, market conditions, or external factors that could impact box-office performance.</li>
<li>The analysis is limited to the data available at the time of the project and does not include any future releases or changes in the film industry that may affect box-office trends.</li>
<li>The project does not consider other factors that may influence box-office performance, such as marketing strategies, competition from other films, or changes in consumer behavior.</li>
</ul>
<p><strong>Most importantly</strong>: the time-series models need at least two weeks of data to capture the weekly seasonality and trend and it assumes that the movie will last at least eleven weeks in theatres. This is a key assumption that may not hold true for all films, especially those with shorter theatrical runs or different release strategies.</p>
<p>Key improvements for the machine learning approach:</p>
<ul>
<li><strong>Feature Engineering</strong>: More features could be added to improve the model’s performance, such as movie genre, director, cast, and marketing budget.</li>
<li><strong>Hyperparameter Tuning</strong>: The models could be further optimized by tuning hyperparameters to achieve better performance, this only applies when suffivient data is available.</li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>